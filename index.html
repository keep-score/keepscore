<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Scoreboard de Billard Anglais</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f0f0f;
            color: white;
            touch-action: manipulation;
            overflow: hidden;
            margin: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0.5rem; 
            padding-bottom: 6rem; 
            gap: 0.5rem;
        }

        /* View Management */
        .view-section {
            flex: 1;
            display: none; /* Hidden by default */
            width: 100%;
            height: 100%;
            animation: fadeIn 0.3s ease-out;
            overflow: hidden; /* Prevent spillover */
        }

        .view-section.active {
            display: flex; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* VIEW 1: SCOREBOARD */
        #view-scores.active {
            flex-direction: column;
            gap: 0.5rem;
            height: 100%;
        }

        @media (min-width: 768px) {
            #view-scores.active {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }
        }

        .score-box {
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly; 
            flex: 1; 
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 4px solid rgba(0,0,0,0.2);
            padding: 0.25rem 0;
            min-height: 0; 
        }

        /* VIEW 2: STATS */
        #view-stats.active {
            flex-direction: column;
            gap: 0.75rem;
            overflow-y: auto;
            align-items: stretch;
            display: grid; 
            grid-template-columns: 1fr;
            padding-bottom: 1rem;
        }

        @media (min-width: 768px) {
            #view-stats.active {
                grid-template-columns: 1fr 1fr;
                overflow-y: hidden;
                padding-bottom: 0;
            }
        }

        .stat-column {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 2rem;
            justify-content: flex-start; 
        }

        .stat-card {
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            border: 2px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        /* VIEW 3: TIMER */
        #view-timer.active {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
            border-radius: 2rem;
            border: 2px solid #333;
        }

        /* Timer Graphic Styles */
        .timer-graphic-container {
            position: relative;
            width: clamp(280px, 55vw, 600px);
            height: clamp(280px, 55vw, 600px);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .timer-svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            transform: rotate(-90deg);
            pointer-events: none;
        }

        .timer-track {
            stroke: rgba(255,255,255,0.05);
            fill: none;
            stroke-width: 4;
        }

        .timer-progress-ring {
            fill: none;
            stroke-width: 4;
            stroke-linecap: round;
            stroke-dasharray: 283; /* 2 * PI * 45 */
            stroke-dashoffset: 0;
            /* Using linear 1s ensures the ring drains exactly in sync with the 1s interval */
            transition: stroke-dashoffset 1s linear, stroke 0.3s;
        }

        /* VIEW 4: DASHBOARD (ALL-IN-ONE) */
        #view-dashboard.active {
            flex-direction: column;
            gap: 0.5rem;
        }

        .dashboard-timer-section {
            flex: 0 0 auto; 
            background: #1a1a1a;
            border-radius: 1.5rem;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #333;
        }

        .dashboard-players-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto; /* Allow scrolling for stats */
            padding-bottom: 1rem;
        }
        
        @media (min-width: 768px) {
            .dashboard-players-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                overflow-y: hidden;
                padding-bottom: 0;
            }
        }
        
        .dashboard-player-card {
            background: #1a1a1a;
            border-radius: 1.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            min-height: 350px; /* Ensure space for stats */
        }
        
        .dash-stat-row {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            justify-content: center;
            margin-top: 0.5rem;
        }
        
        .dash-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 0.25rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(255,255,255,0.05);
            flex: 1;
        }

        .dash-btn {
            width: 44px; height: 44px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.1);
            color: white;
            transition: all 0.2s;
        }
        .dash-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        .dash-btn i { width: 20px; height: 20px; }


        .cue-ball {
            width: clamp(24px, 5vw, 40px);
            height: clamp(24px, 5vw, 40px);
            background-color: #ffffff;
            background: radial-gradient(circle at 30% 30%, #ffffff 0%, #f0f0f0 50%, #d1d1d1 100%);
            border-radius: 50%;
            position: relative;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.5);
            cursor: pointer;
            margin-top: 4px;
            transition: all 0.2s ease;
        }

        .cue-ball.inactive {
            opacity: 0.2; 
            filter: grayscale(1);
            transform: scale(0.9);
        }

        .spot {
            position: absolute;
            width: 15%; height: 15%;
            background-color: #cc0000;
            border-radius: 50%;
        }
        .spot-1 { top: 20%; left: 50%; transform: translateX(-50%); }
        .spot-2 { top: 60%; left: 25%; }
        .spot-3 { top: 60%; left: 75%; }

        .bg-red-pool { background: linear-gradient(135deg, #dc2626, #991b1b); }
        .bg-blue-pool { background: linear-gradient(135deg, #2563eb, #1e40af); }

        .score-text {
            font-size: clamp(6rem, 20vh, 18rem); 
            font-weight: 900;
            line-height: 0.8;
            text-shadow: 0 10px 20px rgba(0,0,0,0.4);
            font-variant-numeric: tabular-nums;
        }

        @media (min-width: 768px) {
            .score-text {
                font-size: clamp(10rem, 35vh, 40rem);
            }
        }

        .score-text-dash {
            font-size: clamp(4rem, 10vh, 10rem);
            font-weight: 900;
            line-height: 0.75;
            text-shadow: 0 5px 15px rgba(0,0,0,0.4);
            font-variant-numeric: tabular-nums;
        }

        .player-name {
            outline: none; 
            padding: 4px 12px;
            white-space: nowrap; 
            font-size: clamp(1.2rem, 4vw, 2.5rem);
            font-weight: 900;
            text-transform: uppercase;
            border-radius: 0.5rem;
        }
        
        .player-name[contenteditable="true"] {
            background: rgba(0,0,0,0.3);
            border-bottom: 2px solid white;
        }

        .footer-controls {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .action-btn {
            height: 54px; width: 54px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(to bottom, #facc15, #eab308);
            color: #000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid #000;
        }
        .action-btn.secondary {
            background: #262626; color: #facc15; border-color: #404040;
            height: 48px; width: 48px;
        }
        .action-btn:active { transform: scale(0.9); }

        .clock-display {
            font-family: 'Monaco', 'Consolas', monospace;
            font-weight: 900;
            line-height: 0.8;
            cursor: pointer;
            transition: color 0.3s;
        }

        /* Specific size for the Main Timer View */
        /* Reduced size to prevent overlap with SVG ring */
        .clock-main {
            font-size: clamp(5rem, 20vw, 12rem); /* Reduced from 6rem, 25vw, 15rem */
        }
        
        @media (min-width: 768px) {
            .clock-main {
                font-size: 15vw; /* Reduced from 20vw */
            }
        }
        
        @media (min-width: 1024px) {
            .clock-main {
                font-size: 18rem; /* Reduced from 25rem */
            }
        }

        .clock-green { color: #22c55e; stroke: #22c55e; }
        .clock-yellow { color: #facc15; stroke: #facc15; }
        .clock-red { color: #ef4444; stroke: #ef4444; animation: pulse-clock 0.5s infinite; }

        .counter-btn {
            width: 44px; height: 44px;
            border-radius: 0.75rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: 900;
            background: rgba(255,255,255,0.1);
        }
        
        .counter-btn-small {
            width: 32px; height: 32px;
            border-radius: 0.5rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; font-weight: 900;
            background: rgba(255,255,255,0.1);
        }
        
        .counter-val {
            font-size: 3rem; font-weight: 900;
            min-width: 1.5ch; text-align: center;
        }
        
        .counter-val-small {
            font-size: 1.5rem; font-weight: 900;
            min-width: 1.2ch; text-align: center;
            margin: 2px 0;
        }

        .voice-toggle-inner.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6; color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }

        #voice-toast {
            position: fixed; top: 2rem; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); border: 1px solid #3b82f6;
            padding: 0.75rem 1.5rem; border-radius: 2rem;
            z-index: 1000; display: none; align-items: center; gap: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            animation: slide-in 0.3s ease-out;
        }

        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 100; display: none;
            align-items: center; justify-content: center;
        }
        #modal-overlay.active { display: flex; }

        .modal-content {
            background: #1a1a1a; border: 2px solid #333;
            border-radius: 2rem; padding: 2.5rem;
            max-width: 400px; width: 90%; text-align: center;
        }

        .ctrl-btn {
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        @keyframes pulse-clock { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes slide-in { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
    </style>
</head>
<body onclick="handleGlobalClick(event)">

    <div id="voice-toast">
        <i data-lucide="mic" class="w-4 h-4 text-blue-400"></i>
        <span id="voice-text" class="text-sm font-bold uppercase tracking-wider"></span>
    </div>

    <div class="main-container">
        
        <!-- VIEW 1: SCOREBOARD -->
        <div id="view-scores" class="view-section active">
            <!-- ROUGE Player -->
            <div class="score-box bg-red-pool" onclick="handleScoreBoxClick('red', event)">
                <div class="flex flex-col items-center gap-1 w-full justify-center pointer-events-none">
                    <div class="player-name-container pointer-events-auto" onclick="handleNameContainerClick(event)">
                        <span id="name-red" class="player-name" spellcheck="false" onblur="disableEditing(this)">ROUGE</span>
                    </div>
                    <div id="break-red" class="cue-ball pointer-events-auto" onclick="handleCueBallClick('red', event)">
                        <div class="spot spot-1"></div><div class="spot spot-2"></div><div class="spot spot-3"></div>
                    </div>
                </div>
                <div class="score-text select-none pointer-events-none" id="score-red">0</div>
                <div class="flex gap-4 w-full max-w-[320px]">
                    <button onclick="changeScore('red', -1, event)" class="btn-active flex-1 bg-black/30 py-4 rounded-2xl text-2xl font-black flex items-center justify-center pointer-events-auto">
                        <i data-lucide="minus" class="w-8 h-8"></i>
                    </button>
                    <button onclick="changeScore('red', 1, event)" class="btn-active flex-[2] bg-white/20 py-4 rounded-2xl text-2xl font-black shadow-lg flex items-center justify-center pointer-events-auto">
                        <i data-lucide="plus" class="w-10 h-10"></i>
                    </button>
                </div>
            </div>

            <!-- BLEU Player -->
            <div class="score-box bg-blue-pool" onclick="handleScoreBoxClick('blue', event)">
                <div class="flex flex-col items-center gap-1 w-full justify-center pointer-events-none">
                    <div class="player-name-container pointer-events-auto" onclick="handleNameContainerClick(event)">
                        <span id="name-blue" class="player-name" spellcheck="false" onblur="disableEditing(this)">BLEU</span>
                    </div>
                    <div id="break-blue" class="cue-ball inactive pointer-events-auto" onclick="handleCueBallClick('blue', event)">
                        <div class="spot spot-1"></div><div class="spot spot-2"></div><div class="spot spot-3"></div>
                    </div>
                </div>
                <div class="score-text select-none pointer-events-none" id="score-blue">0</div>
                <div class="flex gap-4 w-full max-w-[320px]">
                    <button onclick="changeScore('blue', -1, event)" class="btn-active flex-1 bg-black/30 py-4 rounded-2xl text-2xl font-black flex items-center justify-center pointer-events-auto">
                        <i data-lucide="minus" class="w-8 h-8"></i>
                    </button>
                    <button onclick="changeScore('blue', 1, event)" class="btn-active flex-[2] bg-white/20 py-4 rounded-2xl text-2xl font-black shadow-lg flex items-center justify-center pointer-events-auto">
                        <i data-lucide="plus" class="w-10 h-10"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: STATS -->
        <div id="view-stats" class="view-section">
            <div class="stat-column bg-red-pool">
                <!-- Red Mini Scoreboard -->
                <div class="w-full flex flex-col items-center gap-2 mb-4 p-4 rounded-3xl bg-black/20 border-2 border-white/10">
                    <div class="flex items-center gap-3 w-full justify-center relative">
                        <div class="player-name-container pointer-events-auto" onclick="handleNameContainerClick(event)">
                            <span id="name-red-stats" class="player-name text-2xl" spellcheck="false" onblur="disableEditing(this)">ROUGE</span>
                        </div>
                        <div id="break-red-stats" class="cue-ball w-10 h-10" onclick="handleCueBallClick('red', event)">
                             <div class="spot spot-1"></div><div class="spot spot-2"></div><div class="spot spot-3"></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 w-full justify-between mt-1">
                        <button onclick="changeScore('red', -1, event)" class="w-14 h-14 rounded-2xl bg-red-900/60 flex items-center justify-center text-2xl font-black shadow-lg border border-white/5 active:scale-95 transition-transform"><i data-lucide="minus"></i></button>
                        <span id="score-red-stats" class="text-[5rem] font-black tabular-nums leading-none drop-shadow-lg">0</span>
                        <button onclick="changeScore('red', 1, event)" class="w-14 h-14 rounded-2xl bg-white/20 flex items-center justify-center text-3xl font-black shadow-lg border border-white/10 active:scale-95 transition-transform"><i data-lucide="plus"></i></button>
                    </div>
                </div>
                
                <div class="stat-card">
                    <button onclick="changeCounter('red', 1, -1, event)" class="counter-btn"><i data-lucide="minus"></i></button>
                    <span id="counter-red-1" class="counter-val">0</span>
                    <button onclick="changeCounter('red', 1, 1, event)" class="counter-btn"><i data-lucide="plus"></i></button>
                </div>
                <div class="stat-card">
                    <button onclick="changeCounter('red', 2, -1, event)" class="counter-btn"><i data-lucide="minus"></i></button>
                    <span id="counter-red-2" class="counter-val">0</span>
                    <button onclick="changeCounter('red', 2, 1, event)" class="counter-btn"><i data-lucide="plus"></i></button>
                </div>
                <div class="stat-card">
                    <button onclick="changeCounter('red', 3, -1, event)" class="counter-btn"><i data-lucide="minus"></i></button>
                    <span id="counter-red-3" class="counter-val">0</span>
                    <button onclick="changeCounter('red', 3, 1, event)" class="counter-btn"><i data-lucide="plus"></i></button>
                </div>
            </div>

            <div class="stat-column bg-blue-pool">
                <!-- Blue Mini Scoreboard -->
                <div class="w-full flex flex-col items-center gap-2 mb-4 p-4 rounded-3xl bg-black/20 border-2 border-white/10">
                    <div class="flex items-center gap-3 w-full justify-center relative">
                        <div class="player-name-container pointer-events-auto" onclick="handleNameContainerClick(event)">
                            <span id="name-blue-stats" class="player-name text-2xl" spellcheck="false" onblur="disableEditing(this)">BLEU</span>
                        </div>
                        <div id="break-blue-stats" class="cue-ball w-10 h-10 inactive" onclick="handleCueBallClick('blue', event)">
                             <div class="spot spot-1"></div><div class="spot spot-2"></div><div class="spot spot-3"></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 w-full justify-between mt-1">
                        <button onclick="changeScore('blue', -1, event)" class="w-14 h-14 rounded-2xl bg-blue-900/60 flex items-center justify-center text-2xl font-black shadow-lg border border-white/5 active:scale-95 transition-transform"><i data-lucide="minus"></i></button>
                        <span id="score-blue-stats" class="text-[5rem] font-black tabular-nums leading-none drop-shadow-lg">0</span>
                        <button onclick="changeScore('blue', 1, event)" class="w-14 h-14 rounded-2xl bg-white/20 flex items-center justify-center text-3xl font-black shadow-lg border border-white/10 active:scale-95 transition-transform"><i data-lucide="plus"></i></button>
                    </div>
                </div>

                <div class="stat-card">
                    <button onclick="changeCounter('blue', 1, -1, event)" class="counter-btn"><i data-lucide="minus"></i></button>
                    <span id="counter-blue-1" class="counter-val">0</span>
                    <button onclick="changeCounter('blue', 1, 1, event)" class="counter-btn"><i data-lucide="plus"></i></button>
                </div>
                <div class="stat-card">
                    <button onclick="changeCounter('blue', 2, -1, event)" class="counter-btn"><i data-lucide="minus"></i></button>
                    <span id="counter-blue-2" class="counter-val">0</span>
                    <button onclick="changeCounter('blue', 2, 1, event)" class="counter-btn"><i data-lucide="plus"></i></button>
                </div>
                <div class="stat-card">
                    <button onclick="changeCounter('blue', 3, -1, event)" class="counter-btn"><i data-lucide="minus"></i></button>
                    <span id="counter-blue-3" class="counter-val">0</span>
                    <button onclick="changeCounter('blue', 3, 1, event)" class="counter-btn"><i data-lucide="plus"></i></button>
                </div>
            </div>
        </div>

        <!-- VIEW 3: TIMER -->
        <div id="view-timer" class="view-section">
            <div class="flex flex-col items-center justify-center w-full h-full gap-8">
                
                <!-- Animated Timer Graphic -->
                <div class="timer-graphic-container" onclick="handleTimeClick(event)">
                    <svg class="timer-svg" viewBox="0 0 100 100">
                        <!-- Background Track -->
                        <circle cx="50" cy="50" r="45" class="timer-track" />
                        <!-- Moving Progress Ring -->
                        <circle id="timer-ring" cx="50" cy="50" r="45" class="timer-progress-ring clock-green" />
                    </svg>
                    <!-- Time Display (Large) -->
                    <div id="clock-timer" class="clock-display clock-main clock-green absolute z-10">30</div>
                </div>
                
                <div class="flex gap-4 w-full max-w-md px-4">
                    <button onclick="toggleVoiceControl()" id="voice-btn-inner" class="voice-toggle-inner flex-1 py-6 rounded-3xl flex justify-center items-center transition-all border border-white/10 btn-active">
                        <i data-lucide="mic" class="w-8 h-8"></i>
                    </button>
                    <button onclick="toggleClock(event)" id="clock-toggle" class="flex-[2] py-6 bg-white/10 text-white rounded-3xl border border-white/10 flex justify-center btn-active">
                        <i id="toggle-icon" data-lucide="play" class="w-10 h-10 fill-current"></i>
                    </button>
                    <button id="extension-btn" onclick="addExtension(event)" class="flex-1 py-6 bg-white/10 text-white rounded-3xl border border-white/10 flex justify-center btn-active">
                        <i data-lucide="plus" class="w-8 h-8 stroke-[3]"></i>
                    </button>
                </div>
                
                <p class="text-white/30 text-sm font-bold tracking-widest mt-4 uppercase">Appuyez sur le temps pour réinitialiser</p>
            </div>
        </div>

        <!-- VIEW 4: DASHBOARD (ALL IN ONE) -->
        <div id="view-dashboard" class="view-section">
            <!-- Timer Header -->
            <div class="dashboard-timer-section">
                <!-- Controls Left -->
                <div class="flex gap-2">
                    <button onclick="toggleClock(event)" class="dash-btn bg-white/10 hover:bg-white/20">
                        <i id="dash-clock-icon" data-lucide="play" class="fill-current"></i>
                    </button>
                    <button onclick="addExtension(event)" id="dash-ext-btn" class="dash-btn bg-white/10 hover:bg-white/20">
                        <i data-lucide="plus"></i>
                    </button>
                </div>
                <!-- Timer Display -->
                <div id="clock-dashboard" class="clock-display text-5xl font-black clock-green" onclick="handleTimeClick(event)">30</div>
                <!-- Controls Right -->
                <div class="flex gap-2">
                    <button onclick="toggleVoiceControl()" id="dash-voice-btn" class="dash-btn bg-white/10 hover:bg-white/20 voice-toggle-inner">
                        <i data-lucide="mic"></i>
                    </button>
                </div>
            </div>

            <!-- Players Split -->
            <div class="dashboard-players-container">
                <!-- RED DASHBOARD -->
                <div class="dashboard-player-card bg-red-pool" onclick="handleScoreBoxClick('red', event)">
                    <!-- Name & Break -->
                    <div class="flex flex-col items-center gap-1 w-full justify-center pointer-events-none">
                        <div class="player-name-container pointer-events-auto" onclick="handleNameContainerClick(event)">
                            <span id="name-red-dashboard" class="player-name text-2xl" spellcheck="false" onblur="disableEditing(this)">ROUGE</span>
                        </div>
                        <div id="break-red-dashboard" class="cue-ball w-8 h-8 pointer-events-auto" onclick="handleCueBallClick('red', event)">
                            <div class="spot spot-1"></div><div class="spot spot-2"></div><div class="spot spot-3"></div>
                        </div>
                    </div>
                    
                    <!-- Main Score -->
                    <div class="score-text-dash select-none pointer-events-none" id="score-red-dashboard">0</div>
                    
                    <!-- Score Controls -->
                    <div class="flex gap-2 w-full max-w-[200px] px-2 mb-2">
                        <button onclick="changeScore('red', -1, event)" class="btn-active flex-1 bg-black/30 py-3 rounded-xl text-xl font-black flex items-center justify-center pointer-events-auto">
                            <i data-lucide="minus" class="w-6 h-6"></i>
                        </button>
                        <button onclick="changeScore('red', 1, event)" class="btn-active flex-[1.5] bg-white/20 py-3 rounded-xl text-xl font-black shadow-lg flex items-center justify-center pointer-events-auto">
                            <i data-lucide="plus" class="w-8 h-8"></i>
                        </button>
                    </div>

                    <!-- Extra Counters (Stats) -->
                    <div class="dash-stat-row pointer-events-auto">
                        <div class="dash-stat-item">
                            <button onclick="changeCounter('red', 1, 1, event)" class="counter-btn-small mb-1"><i data-lucide="chevron-up" class="w-4 h-4"></i></button>
                            <span id="counter-red-1-dashboard" class="counter-val-small">0</span>
                            <button onclick="changeCounter('red', 1, -1, event)" class="counter-btn-small mt-1"><i data-lucide="chevron-down" class="w-4 h-4"></i></button>
                        </div>
                        <div class="dash-stat-item">
                            <button onclick="changeCounter('red', 2, 1, event)" class="counter-btn-small mb-1"><i data-lucide="chevron-up" class="w-4 h-4"></i></button>
                            <span id="counter-red-2-dashboard" class="counter-val-small">0</span>
                            <button onclick="changeCounter('red', 2, -1, event)" class="counter-btn-small mt-1"><i data-lucide="chevron-down" class="w-4 h-4"></i></button>
                        </div>
                        <div class="dash-stat-item">
                            <button onclick="changeCounter('red', 3, 1, event)" class="counter-btn-small mb-1"><i data-lucide="chevron-up" class="w-4 h-4"></i></button>
                            <span id="counter-red-3-dashboard" class="counter-val-small">0</span>
                            <button onclick="changeCounter('red', 3, -1, event)" class="counter-btn-small mt-1"><i data-lucide="chevron-down" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>

                <!-- BLUE DASHBOARD -->
                <div class="dashboard-player-card bg-blue-pool" onclick="handleScoreBoxClick('blue', event)">
                    <!-- Name & Break -->
                    <div class="flex flex-col items-center gap-1 w-full justify-center pointer-events-none">
                        <div class="player-name-container pointer-events-auto" onclick="handleNameContainerClick(event)">
                            <span id="name-blue-dashboard" class="player-name text-2xl" spellcheck="false" onblur="disableEditing(this)">BLEU</span>
                        </div>
                        <div id="break-blue-dashboard" class="cue-ball w-8 h-8 inactive pointer-events-auto" onclick="handleCueBallClick('blue', event)">
                            <div class="spot spot-1"></div><div class="spot spot-2"></div><div class="spot spot-3"></div>
                        </div>
                    </div>
                    
                    <!-- Main Score -->
                    <div class="score-text-dash select-none pointer-events-none" id="score-blue-dashboard">0</div>
                    
                    <!-- Score Controls -->
                    <div class="flex gap-2 w-full max-w-[200px] px-2 mb-2">
                        <button onclick="changeScore('blue', -1, event)" class="btn-active flex-1 bg-black/30 py-3 rounded-xl text-xl font-black flex items-center justify-center pointer-events-auto">
                            <i data-lucide="minus" class="w-6 h-6"></i>
                        </button>
                        <button onclick="changeScore('blue', 1, event)" class="btn-active flex-[1.5] bg-white/20 py-3 rounded-xl text-xl font-black shadow-lg flex items-center justify-center pointer-events-auto">
                            <i data-lucide="plus" class="w-8 h-8"></i>
                        </button>
                    </div>

                    <!-- Extra Counters (Stats) -->
                    <div class="dash-stat-row pointer-events-auto">
                         <div class="dash-stat-item">
                            <button onclick="changeCounter('blue', 1, 1, event)" class="counter-btn-small mb-1"><i data-lucide="chevron-up" class="w-4 h-4"></i></button>
                            <span id="counter-blue-1-dashboard" class="counter-val-small">0</span>
                            <button onclick="changeCounter('blue', 1, -1, event)" class="counter-btn-small mt-1"><i data-lucide="chevron-down" class="w-4 h-4"></i></button>
                        </div>
                        <div class="dash-stat-item">
                            <button onclick="changeCounter('blue', 2, 1, event)" class="counter-btn-small mb-1"><i data-lucide="chevron-up" class="w-4 h-4"></i></button>
                            <span id="counter-blue-2-dashboard" class="counter-val-small">0</span>
                            <button onclick="changeCounter('blue', 2, -1, event)" class="counter-btn-small mt-1"><i data-lucide="chevron-down" class="w-4 h-4"></i></button>
                        </div>
                        <div class="dash-stat-item">
                            <button onclick="changeCounter('blue', 3, 1, event)" class="counter-btn-small mb-1"><i data-lucide="chevron-up" class="w-4 h-4"></i></button>
                            <span id="counter-blue-3-dashboard" class="counter-val-small">0</span>
                            <button onclick="changeCounter('blue', 3, -1, event)" class="counter-btn-small mt-1"><i data-lucide="chevron-down" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer-controls">
            <!-- Left: Reset -->
            <button onclick="showResetModal()" class="action-btn secondary" title="Reset Match">
                <i data-lucide="rotate-ccw" class="w-6 h-6"></i>
            </button>

            <!-- Center: Cycle View -->
            <button id="cycle-view-btn" onclick="cycleView()" class="action-btn" title="Switch View">
                <i id="view-icon" data-lucide="layers" class="w-8 h-8"></i>
            </button>

            <!-- Right: Full Screen -->
            <button onclick="toggleFullScreen()" class="action-btn secondary" title="Full Screen">
                <i id="fs-icon" data-lucide="maximize" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="modal-overlay">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="text-xl font-black mb-1">RÉINITIALISER ?</h2>
            <p class="text-white/60 mb-6 text-xs">Les noms, scores et statistiques seront effacés.</p>
            <div class="flex gap-4">
                <button onclick="closeResetModal()" class="flex-1 py-3 bg-white/10 rounded-xl font-bold uppercase tracking-widest text-[10px] btn-active">Annuler</button>
                <button onclick="confirmReset()" class="flex-1 py-3 bg-red-600 rounded-xl font-bold uppercase tracking-widest text-[10px] btn-active shadow-lg">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        let currentView = 0; // 0: Scores, 1: Stats, 2: Timer, 3: Dashboard
        const views = ['view-scores', 'view-stats', 'view-timer', 'view-dashboard'];
        
        let scores = { red: 0, blue: 0 };
        let counters = { red: { 1: 0, 2: 0, 3: 0 }, blue: { 1: 0, 2: 0, 3: 0 } };
        let currentBreak = 'red';
        let timerSeconds = 30;
        let clockInterval = null;
        let isClockRunning = false;
        let wasManuallyPaused = false;
        let extensionUsed = false;
        let totalTimerDuration = 30; // New state for animation
        let audioCtx;
        let recognition;
        let isVoiceActive = false;

        // --- VIEW MANAGEMENT ---
        function cycleView() {
            // Hide current
            document.getElementById(views[currentView]).classList.remove('active');
            
            // Move to next
            currentView = (currentView + 1) % views.length;
            
            // Show next
            document.getElementById(views[currentView]).classList.add('active');

            // Logic: Pause clock if leaving Timer view (Index 2) or Dashboard (Index 3)
            if ((currentView === 0 || currentView === 1) && isClockRunning) {
                stopClock();
                updateClockButtons();
            }

            playSound(500, 700, 'sine', 0.05, 0.1);
            lucide.createIcons();
        }

        // --- EDITING LOGIC ---
        function handleNameContainerClick(e) {
            e.stopPropagation();
            const nameEl = e.currentTarget.querySelector('.player-name');
            enableEditing(nameEl);
        }

        function enableEditing(el) {
            if (el.contentEditable === "true") return;
            el.contentEditable = "true";
            el.focus();
            setTimeout(() => {
                const range = document.createRange();
                range.selectNodeContents(el);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }, 50);
            playSound(700, 900, 'sine', 0.05, 0.1);
        }

        function disableEditing(el) { 
            el.contentEditable = "false"; 
            
            // Synchronize Names across views
            const id = el.id;
            const val = el.innerText;
            if(id.includes('red')) {
                if(document.getElementById('name-red')) document.getElementById('name-red').innerText = val;
                if(document.getElementById('name-red-stats')) document.getElementById('name-red-stats').innerText = val;
                if(document.getElementById('name-red-dashboard')) document.getElementById('name-red-dashboard').innerText = val;
            } else if (id.includes('blue')) {
                if(document.getElementById('name-blue')) document.getElementById('name-blue').innerText = val;
                if(document.getElementById('name-blue-stats')) document.getElementById('name-blue-stats').innerText = val;
                if(document.getElementById('name-blue-dashboard')) document.getElementById('name-blue-dashboard').innerText = val;
            }
        }

        function getAudioCtx() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            return audioCtx;
        }

        function handleGlobalClick(e) {
            // Only relevant if we are in Timer view (Index 2) or Dashboard (Index 3)
            if (currentView !== 2 && currentView !== 3) return;

            const isControl = e.target.closest('button') || 
                              e.target.closest('#modal-overlay');
            
            if (!isControl) {
                // handleTimeClick(e); // Optional: Click background to reset? Disabled for cleaner UX in tabs
            }
        }

        function handleScoreBoxClick(player, e) {
            // Placeholder if needed
        }

        // --- CLOCK ---
        function toggleClock(e) { 
            if (e) e.stopPropagation();
            if (isClockRunning) {
                wasManuallyPaused = true;
                stopClock();
            } else {
                wasManuallyPaused = false;
                startClock();
            }
            updateClockButtons();
        }
        
        function startClock() {
            if (isClockRunning) return;
            isClockRunning = true;
            if (clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(() => {
                timerSeconds--;
                updateClockUI();
                checkClockAudio();
                if (timerSeconds <= 0) { 
                    stopClock(); 
                    updateClockButtons();
                    playSound(220, 110, 'square', 0.15, 0.6); 
                }
            }, 1000);
        }

        function stopClock() {
            isClockRunning = false;
            if (clockInterval) clearInterval(clockInterval);
        }

        function updateClockButtons() {
            // Main Timer View Icon
            const icon = document.getElementById('toggle-icon');
            if (icon) {
                if (isClockRunning) icon.setAttribute('data-lucide', 'pause');
                else icon.setAttribute('data-lucide', 'play');
            }
            
            // Dashboard View Icon
            const dashIcon = document.getElementById('dash-clock-icon');
            if (dashIcon) {
                if (isClockRunning) dashIcon.setAttribute('data-lucide', 'pause');
                else dashIcon.setAttribute('data-lucide', 'play');
            }

            lucide.createIcons();
        }

        function resetExtension() {
            extensionUsed = false;
            const btn = document.getElementById('extension-btn');
            if (btn) btn.disabled = false;
            
            const dashBtn = document.getElementById('dash-ext-btn');
            if (dashBtn) dashBtn.disabled = false;
        }

        function handleTimeClick(e) {
            if (e) e.stopPropagation();
            const wasPaused = !isClockRunning && wasManuallyPaused;
            stopClock();
            timerSeconds = 30;
            totalTimerDuration = 30; // Reset graphic max
            resetExtension();
            updateClockUI();
            playSound(400, 600, 'sine', 0.05, 0.1);
            if (wasPaused) wasManuallyPaused = true; 
            else { wasManuallyPaused = false; startClock(); }
            updateClockButtons();
        }

        function addExtension(e) {
            if (e) e.stopPropagation();
            if (extensionUsed) return;
            extensionUsed = true;
            timerSeconds += 15;
            totalTimerDuration = 45; // Update graphic max scale
            
            const btn = document.getElementById('extension-btn');
            if(btn) btn.disabled = true;
            
            const dashBtn = document.getElementById('dash-ext-btn');
            if(dashBtn) dashBtn.disabled = true;

            updateClockUI();
            if (!isClockRunning && !wasManuallyPaused) startClock();
            updateClockButtons();
            playSound(1200, 800, 'sine', 0.05, 0.2);
        }

        function updateClockUI() {
            // Text Displays
            const displays = [
                document.getElementById('clock-timer'),
                document.getElementById('clock-dashboard')
            ];

            // Graphic Ring
            const ring = document.getElementById('timer-ring');
            const ringCircumference = 283; // 2 * pi * 45

            let colorClass = 'clock-green';
            let strokeColor = '#22c55e'; // Green default

            if (timerSeconds <= 10 && timerSeconds > 5) {
                colorClass = 'clock-yellow';
                strokeColor = '#facc15';
            } else if (timerSeconds <= 5) {
                colorClass = 'clock-red';
                strokeColor = '#ef4444';
            }

            // Update Texts
            displays.forEach(display => {
                if (!display) return;
                display.innerText = timerSeconds;
                display.classList.remove('clock-green', 'clock-yellow', 'clock-red');
                display.classList.add(colorClass);
            });

            // Update SVG Ring
            // We set target to timerSeconds - 1 to sync visual completion with countdown arrival
            // e.g. If time is 30, target 29. Ring drains 30->29 over 1s.
            if (ring) {
                let targetTime = timerSeconds;
                if (isClockRunning && timerSeconds > 0) {
                    targetTime = timerSeconds - 1;
                }
                const progress = Math.max(0, targetTime / totalTimerDuration);
                const offset = ringCircumference - (progress * ringCircumference);
                
                ring.style.strokeDashoffset = offset;
                ring.style.stroke = strokeColor;
            }
        }

        function checkClockAudio() {
            if (timerSeconds === 10) playSound(500, 500, 'sine', 0.1, 0.2);
            else if (timerSeconds <= 5 && timerSeconds > 0) playSound(880, 880, 'sine', 0.1, 0.1);
        }

        // --- SCORES ---
        function changeScore(player, delta, e) {
            if (e) e.stopPropagation();
            scores[player] = Math.max(0, scores[player] + delta);
            
            // Update Main Score
            const mainScoreEl = document.getElementById(`score-${player}`);
            if (mainScoreEl) mainScoreEl.innerText = scores[player];

            // Update Stats Score (Synchronized)
            const statsScoreEl = document.getElementById(`score-${player}-stats`);
            if (statsScoreEl) statsScoreEl.innerText = scores[player];

            // Update Dashboard Score (Synchronized)
            const dashScoreEl = document.getElementById(`score-${player}-dashboard`);
            if (dashScoreEl) dashScoreEl.innerText = scores[player];

            if (delta > 0) {
                playSound(880, 1200, 'sine', 0.05, 0.1);
                toggleBreak(); 
            } else if (delta < 0) {
                playSound(440, 220, 'sine', 0.04, 0.12);
            }
        }

        function changeCounter(player, id, delta, e) {
            if (e) e.stopPropagation();
            counters[player][id] = Math.max(0, counters[player][id] + delta);
            
            // Update Stats View Counter
            const mainEl = document.getElementById(`counter-${player}-${id}`);
            if(mainEl) mainEl.innerText = counters[player][id];

            // Update Dashboard View Counter
            const dashEl = document.getElementById(`counter-${player}-${id}-dashboard`);
            if(dashEl) dashEl.innerText = counters[player][id];
        }

        function handleCueBallClick(targetPlayer, e) {
            if (e) e.stopPropagation();
            playSound(600, 600, 'sine', 0.05, 0.08);
            if (currentBreak === targetPlayer) toggleBreak();
            else setBreak(targetPlayer);
        }

        function toggleBreak() {
            const nextPlayer = (currentBreak === 'red') ? 'blue' : 'red';
            setBreak(nextPlayer);
        }

        function setBreak(player) {
            currentBreak = player;
            const ids = [
                `break-red`, `break-blue`, 
                `break-red-stats`, `break-blue-stats`,
                `break-red-dashboard`, `break-blue-dashboard`
            ];
            
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                
                if (id.includes(player)) {
                    el.classList.remove('inactive');
                } else {
                    el.classList.add('inactive');
                }
            });
        }

        // --- RESET & FULLSCREEN ---
        function showResetModal() {
            document.getElementById('modal-overlay').classList.add('active');
            playSound(400, 300, 'sine', 0.05, 0.1);
        }
        function closeResetModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }
        function confirmReset() {
            scores.red = 0; scores.blue = 0;
            // Reset Main View
            document.getElementById('score-red').innerText = 0;
            document.getElementById('score-blue').innerText = 0;
            // Reset Stats View (Sync)
            if(document.getElementById('score-red-stats')) document.getElementById('score-red-stats').innerText = 0;
            if(document.getElementById('score-blue-stats')) document.getElementById('score-blue-stats').innerText = 0;
            // Reset Dashboard View (Sync)
            if(document.getElementById('score-red-dashboard')) document.getElementById('score-red-dashboard').innerText = 0;
            if(document.getElementById('score-blue-dashboard')) document.getElementById('score-blue-dashboard').innerText = 0;
            
            // Reset Names
            if(document.getElementById('name-red')) document.getElementById('name-red').innerText = "ROUGE";
            if(document.getElementById('name-red-stats')) document.getElementById('name-red-stats').innerText = "ROUGE";
            if(document.getElementById('name-red-dashboard')) document.getElementById('name-red-dashboard').innerText = "ROUGE";
            
            if(document.getElementById('name-blue')) document.getElementById('name-blue').innerText = "BLEU";
            if(document.getElementById('name-blue-stats')) document.getElementById('name-blue-stats').innerText = "BLEU";
            if(document.getElementById('name-blue-dashboard')) document.getElementById('name-blue-dashboard').innerText = "BLEU";

            for (let p of ['red', 'blue']) {
                for (let i = 1; i <= 3; i++) {
                    counters[p][i] = 0;
                    const mainEl = document.getElementById(`counter-${p}-${i}`);
                    if(mainEl) mainEl.innerText = 0;
                    
                    const dashEl = document.getElementById(`counter-${p}-${i}-dashboard`);
                    if(dashEl) dashEl.innerText = 0;
                }
            }
            stopClock();
            timerSeconds = 30;
            totalTimerDuration = 30; // Reset graphic scaling
            resetExtension();
            updateClockUI();
            updateClockButtons();
            setBreak('red');
            closeResetModal();
            playSound(200, 600, 'sine', 0.1, 0.3);
        }

        function toggleFullScreen() {
            const doc = document.documentElement;
            if (!document.fullscreenElement) {
                if (doc.requestFullscreen) doc.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        // --- AUDIO & VOICE ---
        function playSound(f1, f2, type, vol, dur) {
            try {
                const ctx = getAudioCtx();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(f1, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(f2, ctx.currentTime + dur/2);
                gain.gain.setValueAtTime(0, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(vol, ctx.currentTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + dur);
            } catch (e) {}
        }

        // Voice
        const resetKeywords = ['next', 'reset', 'time', 'go', 'suivant', 'joué', 'temps', 'prêt', 'vas-y', 'allez', 'ok'];
        const extensionKeywords = ['extension', 'extention', 'extansion', 'rallonge', 'prolongation', 'plus'];

        function toggleVoiceControl() {
            getAudioCtx();
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!recognition) {
                if (!SpeechRecognition) return;
                recognition = new SpeechRecognition();
                recognition.lang = 'fr-FR';
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.onresult = (event) => {
                    const command = event.results[event.results.length - 1][0].transcript.toLowerCase();
                    if (resetKeywords.some(k => command.includes(k))) handleTimeClick();
                    if (extensionKeywords.some(k => command.includes(k)) && !extensionUsed) addExtension();
                };
                recognition.onend = () => { if(isVoiceActive) try { recognition.start(); } catch(e){} };
            }

            const btn = document.getElementById('voice-btn-inner');
            const dashBtn = document.getElementById('dash-voice-btn');
            isVoiceActive = !isVoiceActive;

            if (isVoiceActive) {
                try { 
                    recognition.start(); 
                    if(btn) btn.classList.add('active'); 
                    if(dashBtn) dashBtn.classList.add('active');
                    playSound(800, 1000, 'sine', 0.1, 0.2); 
                } catch(e) {}
            } else {
                recognition.stop(); 
                if(btn) btn.classList.remove('active'); 
                if(dashBtn) dashBtn.classList.remove('active');
                playSound(400, 300, 'sine', 0.05, 0.2);
            }
        }

        function selectAllText(element) {
            setTimeout(() => {
                const range = document.createRange();
                range.selectNodeContents(element);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }, 50);
        }
        function clearSelection() { if (window.getSelection) window.getSelection().removeAllRanges(); }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.getAttribute('contenteditable')) {
                e.preventDefault(); e.target.blur();
            }
        });
        
        window.onload = () => {
            lucide.createIcons();
            updateClockUI();
            setBreak('red'); 
        };
    </script>
</body>
</html>
