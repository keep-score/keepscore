<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Scoreboard de Billard Anglais</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f0f0f;
            color: white;
            touch-action: manipulation;
            overflow-x: hidden;
            /* Allow vertical scroll on small screens if needed, otherwise hidden */
            overflow-y: auto; 
            margin: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            height: 100dvh;
        }

        .main-container {
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
            padding-bottom: 6rem; /* Extra space for footer */
            gap: 0.5rem;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scores-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            flex: 1; 
            min-height: 40vh; /* Ensure scores always have height */
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.advanced-mode .scores-wrapper {
            flex: 0.6; 
        }

        #advanced-panel {
            display: none;
            opacity: 0;
            background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
            border-radius: 1.5rem;
            border: 2px solid #333;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
            transition: opacity 0.3s ease;
        }

        body.advanced-mode #advanced-panel {
            display: flex;
            flex: 0.4; 
            /* On mobile, allow this panel to grow if needed */
            flex-shrink: 0;
            opacity: 1;
            padding: 1rem;
            align-items: center;
            justify-content: center;
        }

        .score-box {
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
        }

        .cue-ball {
            width: clamp(20px, 4vw, 36px);
            height: clamp(20px, 4vw, 36px);
            background-color: #ffffff;
            background: radial-gradient(circle at 30% 30%, #ffffff 0%, #f0f0f0 50%, #d1d1d1 100%);
            border-radius: 50%;
            position: relative;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.5);
            display: inline-block;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-top: 4px;
            border: none;
        }

        .cue-ball.inactive {
            opacity: 0.2; 
            filter: grayscale(1);
            transform: scale(0.9);
        }

        .spot {
            position: absolute;
            width: 15%;
            height: 15%;
            background-color: #cc0000;
            border-radius: 50%;
        }

        .spot-1 { top: 20%; left: 50%; transform: translateX(-50%); }
        .spot-2 { top: 60%; left: 25%; }
        .spot-3 { top: 60%; left: 75%; }

        .bg-red-pool { background: linear-gradient(135deg, #dc2626, #991b1b); }
        .bg-blue-pool { background: linear-gradient(135deg, #2563eb, #1e40af); }

        .score-text {
            /* Adjusted clamp for better mobile scaling */
            font-size: clamp(5rem, 30vw, 25rem); 
            font-weight: 900;
            line-height: 0.75;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            text-shadow: 0 10px 20px rgba(0,0,0,0.4);
            font-variant-numeric: tabular-nums;
        }

        body.advanced-mode .score-text {
            font-size: clamp(3.5rem, 15vh, 12rem);
        }

        .player-name-container {
            width: 100%;
            max-width: 90%;
            display: grid;
            place-content: center;
            overflow: hidden;
            position: relative;
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }

        .player-name {
            outline: none; 
            border-bottom: 2px solid transparent;
            transition: border-bottom 0.2s;
            padding: 2px 10px;
            white-space: nowrap; 
            line-height: 1.1;
            /* Scaled down min size for mobile */
            font-size: clamp(1.25rem, 4vw, 2.5rem);
            font-weight: 900;
            text-transform: uppercase;
            display: block;
            user-select: text;
        }
        
        .player-name:focus {
            border-bottom: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            border-radius: 0.5rem;
        }

        .footer-controls {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
        }

        .action-btn {
            height: 54px;
            width: 54px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to bottom, #facc15, #eab308);
            color: #000;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid #000;
            position: relative;
        }

        .action-btn::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 4px solid #facc15;
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        }

        .action-btn.pressing::after {
            opacity: 1;
            transform: scale(1.1);
            transition: transform 0.8s linear, opacity 0.1s;
        }

        .advanced-grid {
            display: grid;
            /* Adaptive grid: 1 column on mobile, 3 columns on tablet/desktop */
            grid-template-columns: 1fr;
            width: 100%;
            height: 100%;
            align-items: center;
            gap: 1.5rem;
            overflow-y: auto; /* Allow scrolling inside panel on tiny screens */
        }

        @media (min-width: 768px) {
            .advanced-grid {
                grid-template-columns: 1fr 1.5fr 1fr;
                overflow-y: visible;
            }
        }

        .clock-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            order: -1; /* Clock always on top on mobile */
        }

        @media (min-width: 768px) {
            .clock-container { order: 0; } /* Clock in middle on desktop */
        }

        .clock-display {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: clamp(4rem, 15vh, 12rem);
            font-weight: 900;
            line-height: 0.8;
            transition: color 0.3s ease;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .clock-green { color: #22c55e; text-shadow: 0 0 30px rgba(34, 197, 94, 0.2); }
        .clock-orange { color: #f97316; text-shadow: 0 0 30px rgba(249, 115, 22, 0.3); }
        .clock-red { 
            color: #ef4444; 
            text-shadow: 0 0 40px rgba(239, 68, 68, 0.4); 
            animation: pulse-clock 0.5s infinite;
        }

        .stat-column {
            display: flex;
            flex-direction: row; /* Horizontal on mobile */
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .stat-column {
                flex-direction: column; /* Vertical on desktop */
                flex-wrap: nowrap;
            }
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 0.75rem;
            padding: 0.4rem;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            /* Adaptive width for stats */
            min-width: 120px;
            max-width: 160px; 
            flex: 1;
        }

        .counter-btn {
            width: 32px;
            height: 32px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 900;
            background: transparent;
        }

        .counter-val {
            font-size: 1.25rem;
            font-weight: 900;
            min-width: 1.5ch;
            text-align: center;
        }

        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #modal-overlay.active { display: flex; opacity: 1; }

        .modal-content {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 2rem;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .ctrl-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .ctrl-btn:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }

        @keyframes pulse-clock { 
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="scores-wrapper">
            <!-- ROUGE Player -->
            <div class="score-box bg-red-pool rounded-[1.5rem] md:rounded-[2rem] p-3 md:p-4 shadow-2xl border-4 border-black/20">
                <div class="flex flex-col items-center gap-1 w-full justify-center pointer-events-none">
                    <div class="player-name-container pointer-events-auto">
                        <span id="name-red" class="player-name" contenteditable="true" spellcheck="false" onfocus="selectAllText(this)" onblur="clearSelection()">ROUGE</span>
                    </div>
                    <div id="break-red" class="cue-ball pointer-events-auto" onclick="handleCueBallClick('red')">
                        <div class="spot spot-1"></div><div class="spot spot-2"></div><div class="spot spot-3"></div>
                    </div>
                </div>
                <div class="score-text select-none pointer-events-none" id="score-red">0</div>
                <div class="flex gap-3 w-full max-w-[280px]">
                    <button onclick="changeScore('red', -1, event)" class="btn-active flex-1 bg-black/30 py-3 rounded-xl flex items-center justify-center pointer-events-auto">
                        <i data-lucide="minus" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </button>
                    <button onclick="changeScore('red', 1, event)" class="btn-active flex-[2] bg-white/20 py-3 rounded-xl shadow-lg flex items-center justify-center pointer-events-auto">
                        <i data-lucide="plus" class="w-7 h-7 md:w-8 md:h-8"></i>
                    </button>
                </div>
            </div>

            <!-- BLEU Player -->
            <div class="score-box bg-blue-pool rounded-[1.5rem] md:rounded-[2rem] p-3 md:p-4 shadow-2xl border-4 border-black/20">
                <div class="flex flex-col items-center gap-1 w-full justify-center pointer-events-none">
                    <div class="player-name-container pointer-events-auto">
                        <span id="name-blue" class="player-name" contenteditable="true" spellcheck="false" onfocus="selectAllText(this)" onblur="clearSelection()">BLEU</span>
                    </div>
                    <div id="break-blue" class="cue-ball inactive pointer-events-auto" onclick="handleCueBallClick('blue')">
                        <div class="spot spot-1"></div><div class="spot spot-2"></div><div class="spot spot-3"></div>
                    </div>
                </div>
                <div class="score-text select-none pointer-events-none" id="score-blue">0</div>
                <div class="flex gap-3 w-full max-w-[280px]">
                    <button onclick="changeScore('blue', -1, event)" class="btn-active flex-1 bg-black/30 py-3 rounded-xl flex items-center justify-center pointer-events-auto">
                        <i data-lucide="minus" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </button>
                    <button onclick="changeScore('blue', 1, event)" class="btn-active flex-[2] bg-white/20 py-3 rounded-xl shadow-lg flex items-center justify-center pointer-events-auto">
                        <i data-lucide="plus" class="w-7 h-7 md:w-8 md:h-8"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ADVANCED PANEL -->
        <div id="advanced-panel">
            <div class="advanced-grid">
                <!-- Center Clock (On top mobile, middle desktop) -->
                <div class="clock-container">
                    <div id="clock-timer" class="clock-display clock-green" onclick="handleTimeClick(event)">30</div>
                    <div class="flex gap-2 w-full max-w-[220px]">
                        <button onclick="toggleClock(event)" id="clock-toggle" class="ctrl-btn flex-[2] py-3 bg-white/10 text-white rounded-xl btn-active border border-white/10">
                            <i id="toggle-icon" data-lucide="play" class="w-6 h-6 fill-current"></i>
                        </button>
                        <button id="extension-btn" onclick="addExtension(event)" class="ctrl-btn flex-1 py-3 bg-white/10 text-white rounded-xl btn-active border border-white/10">
                            <i data-lucide="plus" class="w-6 h-6 stroke-[3]"></i>
                        </button>
                    </div>
                </div>

                <!-- Red Stats -->
                <div class="stat-column">
                    <div class="stat-card">
                        <button onclick="changeCounter('red', 1, -1, event)" class="counter-btn btn-active text-red-500">
                             <i data-lucide="minus" class="w-4 h-4"></i>
                        </button>
                        <span id="counter-red-1" class="counter-val text-red-400">0</span>
                        <button onclick="changeCounter('red', 1, 1, event)" class="counter-btn btn-active text-red-500">
                             <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="stat-card">
                        <button onclick="changeCounter('red', 2, -1, event)" class="counter-btn btn-active text-red-500">
                             <i data-lucide="minus" class="w-4 h-4"></i>
                        </button>
                        <span id="counter-red-2" class="counter-val text-red-400">0</span>
                        <button onclick="changeCounter('red', 2, 1, event)" class="counter-btn btn-active text-red-500">
                             <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="stat-card">
                        <button onclick="changeCounter('red', 3, -1, event)" class="counter-btn btn-active text-red-500">
                             <i data-lucide="minus" class="w-4 h-4"></i>
                        </button>
                        <span id="counter-red-3" class="counter-val text-red-400">0</span>
                        <button onclick="changeCounter('red', 3, 1, event)" class="counter-btn btn-active text-red-500">
                             <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Blue Stats -->
                <div class="stat-column">
                    <div class="stat-card">
                        <button onclick="changeCounter('blue', 1, -1, event)" class="counter-btn btn-active text-blue-500">
                             <i data-lucide="minus" class="w-4 h-4"></i>
                        </button>
                        <span id="counter-blue-1" class="counter-val text-blue-400">0</span>
                        <button onclick="changeCounter('blue', 1, 1, event)" class="counter-btn btn-active text-blue-500">
                             <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="stat-card">
                        <button onclick="changeCounter('blue', 2, -1, event)" class="counter-btn btn-active text-blue-500">
                             <i data-lucide="minus" class="w-4 h-4"></i>
                        </button>
                        <span id="counter-blue-2" class="counter-val text-blue-400">0</span>
                        <button onclick="changeCounter('blue', 2, 1, event)" class="counter-btn btn-active text-blue-500">
                             <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="stat-card">
                        <button onclick="changeCounter('blue', 3, -1, event)" class="counter-btn btn-active text-blue-500">
                             <i data-lucide="minus" class="w-4 h-4"></i>
                        </button>
                        <span id="counter-blue-3" class="counter-val text-blue-400">0</span>
                        <button onclick="changeCounter('blue', 3, 1, event)" class="counter-btn btn-active text-blue-500">
                             <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-controls">
            <button id="advanced-toggle-btn" class="action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="modal-overlay">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="text-xl font-black mb-1">RÉINITIALISER ?</h2>
            <p class="text-white/60 mb-6 text-xs">Les noms, scores et statistiques seront effacés.</p>
            <div class="flex gap-4">
                <button onclick="closeResetModal()" class="flex-1 py-3 bg-white/10 rounded-xl font-bold uppercase tracking-widest text-[10px] btn-active">Annuler</button>
                <button onclick="confirmReset()" class="flex-1 py-3 bg-red-600 rounded-xl font-bold uppercase tracking-widest text-[10px] btn-active shadow-lg">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        let scores = { red: 0, blue: 0 };
        let counters = {
            red: { 1: 0, 2: 0, 3: 0 },
            blue: { 1: 0, 2: 0, 3: 0 }
        };
        let currentBreak = 'red';
        let timerSeconds = 30;
        let clockInterval = null;
        let isClockRunning = false;
        let wasManuallyPaused = false;
        let extensionUsed = false;
        let audioCtx;

        let pressTimer;
        const actionBtn = document.getElementById('advanced-toggle-btn');

        function setupLongPress() {
            const startPress = (e) => {
                if (e.type === 'touchstart') e.preventDefault();
                actionBtn.classList.add('pressing');
                pressTimer = setTimeout(() => {
                    actionBtn.classList.remove('pressing');
                    showResetModal();
                }, 800);
            };

            const endPress = (e) => {
                clearTimeout(pressTimer);
                if (actionBtn.classList.contains('pressing')) {
                    actionBtn.classList.remove('pressing');
                    toggleAdvancedMode();
                }
            };

            actionBtn.addEventListener('mousedown', startPress);
            actionBtn.addEventListener('touchstart', startPress, {passive: false});
            window.addEventListener('mouseup', endPress);
            window.addEventListener('touchend', endPress);
        }

        function getAudioCtx() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            return audioCtx;
        }

        function toggleAdvancedMode() {
            document.body.classList.toggle('advanced-mode');
            playSound(500, 700, 'sine', 0.05, 0.1);
            lucide.createIcons();
            // Scroll reset if needed
            if (document.body.classList.contains('advanced-mode')) {
                setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
            }
        }

        function toggleClock() { 
            if (isClockRunning) {
                wasManuallyPaused = true;
                stopClock();
            } else {
                wasManuallyPaused = false;
                startClock();
            }
            updateClockButtons();
        }
        
        function startClock() {
            if (isClockRunning) return;
            isClockRunning = true;
            if (clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(() => {
                timerSeconds--;
                updateClockUI();
                checkClockAudio();
                if (timerSeconds <= 0) { 
                    stopClock(); 
                    updateClockButtons();
                    playSound(220, 110, 'square', 0.15, 0.6); 
                }
            }, 1000);
        }

        function stopClock() {
            isClockRunning = false;
            if (clockInterval) clearInterval(clockInterval);
        }

        function updateClockButtons() {
            const icon = document.getElementById('toggle-icon');
            if (icon) {
                icon.setAttribute('data-lucide', isClockRunning ? 'pause' : 'play');
                lucide.createIcons();
            }
        }

        function resetExtension() {
            extensionUsed = false;
            const btn = document.getElementById('extension-btn');
            if (btn) btn.disabled = false;
        }

        function handleTimeClick() {
            timerSeconds = 30;
            resetExtension();
            updateClockUI();
            playSound(400, 600, 'sine', 0.05, 0.1);
            stopClock();
            if (!wasManuallyPaused) startClock();
            updateClockButtons();
        }

        function addExtension() {
            if (extensionUsed) return;
            extensionUsed = true;
            timerSeconds += 15;
            const btn = document.getElementById('extension-btn');
            btn.disabled = true;
            updateClockUI();
            
            if (!isClockRunning) startClock();
            updateClockButtons();
            playSound(1200, 800, 'sine', 0.05, 0.2);
        }

        function updateClockUI() {
            const display = document.getElementById('clock-timer');
            display.innerText = timerSeconds;
            display.classList.remove('clock-green', 'clock-yellow', 'clock-red');
            
            if (timerSeconds > 15) {
                display.classList.add('clock-green');
            } else if (timerSeconds > 10) {
                display.classList.add('clock-yellow');
            } else {
                display.classList.add('clock-red');
            }
        }

        function checkClockAudio() {
            if (timerSeconds === 10) {
                playSound(500, 500, 'sine', 0.1, 0.2);
            } else if (timerSeconds <= 5 && timerSeconds > 0) {
                playSound(880, 880, 'sine', 0.1, 0.1);
            }
        }

        function changeScore(player, delta, e) {
            if (e) e.stopPropagation();
            scores[player] = Math.max(0, scores[player] + delta);
            document.getElementById(`score-${player}`).innerText = scores[player];
            
            if (delta > 0) {
                playSound(880, 1200, 'sine', 0.05, 0.1);
                toggleBreak(); 
                handleTimeClick(); 
            } else if (delta < 0) {
                playSound(440, 220, 'sine', 0.04, 0.12);
            }
        }

        function changeCounter(player, id, delta, e) {
            if (e) e.stopPropagation();
            counters[player][id] = Math.max(0, counters[player][id] + delta);
            document.getElementById(`counter-${player}-${id}`).innerText = counters[player][id];
        }

        function handleCueBallClick(targetPlayer, e) {
            if (e) e.stopPropagation();
            playSound(600, 600, 'sine', 0.05, 0.08);
            if (currentBreak === targetPlayer) toggleBreak();
            else setBreak(targetPlayer);
        }

        function toggleBreak() {
            const nextPlayer = (currentBreak === 'red') ? 'blue' : 'red';
            setBreak(nextPlayer);
        }

        function setBreak(player) {
            currentBreak = player;
            const redIcon = document.getElementById('break-red');
            const blueIcon = document.getElementById('break-blue');
            if (player === 'red') {
                redIcon.classList.remove('inactive');
                blueIcon.classList.add('inactive');
            } else {
                blueIcon.classList.remove('inactive');
                redIcon.classList.add('inactive');
            }
        }

        function showResetModal() {
            document.getElementById('modal-overlay').classList.add('active');
            playSound(400, 300, 'sine', 0.05, 0.1);
        }

        function closeResetModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        function confirmReset() {
            scores.red = 0; scores.blue = 0;
            document.getElementById('score-red').innerText = 0;
            document.getElementById('score-blue').innerText = 0;
            document.getElementById('name-red').innerText = "ROUGE";
            document.getElementById('name-blue').innerText = "BLEU";
            for (let p of ['red', 'blue']) {
                for (let i = 1; i <= 3; i++) {
                    counters[p][i] = 0;
                    document.getElementById(`counter-${p}-${i}`).innerText = 0;
                }
            }
            stopClock();
            timerSeconds = 30;
            resetExtension();
            updateClockUI();
            updateClockButtons();
            setBreak('red');
            closeResetModal();
            playSound(200, 600, 'sine', 0.1, 0.3);
        }

        function playSound(f1, f2, type, vol, dur) {
            try {
                const ctx = getAudioCtx();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(f1, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(f2, ctx.currentTime + dur/2);
                gain.gain.setValueAtTime(0, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(vol, ctx.currentTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + dur);
            } catch (e) {}
        }

        function selectAllText(element) {
            setTimeout(() => {
                const range = document.createRange();
                range.selectNodeContents(element);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }, 50);
        }

        function clearSelection() {
            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.getAttribute('contenteditable')) {
                e.preventDefault();
                e.target.blur();
            }
        });
        
        window.onload = () => {
            lucide.createIcons();
            updateClockUI();
            setBreak('red'); 
            setupLongPress();
        };
    </script>
</body>
</html>
